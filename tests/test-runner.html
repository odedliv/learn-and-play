<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn and Play - Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            direction: ltr;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .test-result {
            margin: 5px 0;
            padding: 8px;
            border-left: 3px solid #ddd;
            background: white;
        }

        .pass {
            border-left-color: #4CAF50;
            background: #f1f8f4;
        }

        .fail {
            border-left-color: #f44336;
            background: #fef1f0;
        }

        .test-summary {
            font-size: 1.2em;
            padding: 15px;
            background: white;
            border-radius: 5px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .success-summary {
            border-left: 5px solid #4CAF50;
        }

        .failure-summary {
            border-left: 5px solid #f44336;
        }

        .error-details {
            color: #d32f2f;
            font-size: 0.9em;
            margin-top: 5px;
            font-family: monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <h1>üß™ Learn and Play Test Suite</h1>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button id="run-all-tests">‚ñ∂Ô∏è Run All Tests</button>
        <button id="run-unit-tests">üîß Run Unit Tests</button>
        <button id="run-integration-tests">üîó Run Integration Tests</button>
        <button id="clear-results">üóëÔ∏è Clear Results</button>
    </div>

    <div id="test-summary"></div>
    <div id="test-results">
        <div class="loading">Click "Run All Tests" to begin...</div>
    </div>

    <script type="module">
        // Simple test framework
        window.TestFramework = class TestFramework {
            constructor() {
                this.reset();
            }

            reset() {
                this.suites = [];
                this.currentSuite = null;
                this.results = [];
            }

            describe(suiteName, testFunction) {
                this.currentSuite = {
                    name: suiteName,
                    tests: []
                };
                this.suites.push(this.currentSuite);

                try {
                    testFunction();
                } catch (error) {
                    console.error(`Error in suite ${suiteName}:`, error);
                }
            }

            it(testName, testFunction) {
                const suite = this.currentSuite || { name: 'Anonymous', tests: [] };
                const startTime = performance.now();

                try {
                    testFunction();
                    const duration = performance.now() - startTime;

                    suite.tests.push({
                        name: testName,
                        passed: true,
                        duration
                    });

                    this.results.push({
                        suite: suite.name,
                        test: testName,
                        passed: true,
                        duration
                    });
                } catch (error) {
                    const duration = performance.now() - startTime;

                    suite.tests.push({
                        name: testName,
                        passed: false,
                        error: error.message,
                        duration
                    });

                    this.results.push({
                        suite: suite.name,
                        test: testName,
                        passed: false,
                        error: error.message,
                        duration
                    });
                }
            }

            expect(actual) {
                const matchers = {
                    toBe(expected) {
                        if (actual !== expected) {
                            throw new Error(`Expected ${JSON.stringify(expected)} but got ${JSON.stringify(actual)}`);
                        }
                    },

                    toEqual(expected) {
                        if (JSON.stringify(actual) !== JSON.stringify(expected)) {
                            throw new Error(`Expected ${JSON.stringify(expected)} but got ${JSON.stringify(actual)}`);
                        }
                    },

                    toContain(item) {
                        if (!actual || !actual.includes) {
                            throw new Error(`Expected value to be an array or string, got ${typeof actual}`);
                        }
                        if (!actual.includes(item)) {
                            throw new Error(`Expected ${JSON.stringify(actual)} to contain ${JSON.stringify(item)}`);
                        }
                    },

                    toBeTruthy() {
                        if (!actual) {
                            throw new Error(`Expected truthy value but got ${JSON.stringify(actual)}`);
                        }
                    },

                    toBeFalsy() {
                        if (actual) {
                            throw new Error(`Expected falsy value but got ${JSON.stringify(actual)}`);
                        }
                    },

                    toBeGreaterThan(value) {
                        if (actual <= value) {
                            throw new Error(`Expected ${actual} to be greater than ${value}`);
                        }
                    },

                    toBeLessThan(value) {
                        if (actual >= value) {
                            throw new Error(`Expected ${actual} to be less than ${value}`);
                        }
                    },

                    toBeDefined() {
                        if (actual === undefined) {
                            throw new Error(`Expected value to be defined, but got undefined`);
                        }
                    },

                    toThrow() {
                        if (typeof actual !== 'function') {
                            throw new Error('Expected a function to test for throwing');
                        }

                        let threw = false;
                        try {
                            actual();
                        } catch (e) {
                            threw = true;
                        }

                        if (!threw) {
                            throw new Error('Expected function to throw an error');
                        }
                    }
                };

                // Add .not property for negated assertions
                const notMatchers = {
                    toBe(expected) {
                        if (actual === expected) {
                            throw new Error(`Expected ${JSON.stringify(actual)} NOT to be ${JSON.stringify(expected)}`);
                        }
                    },

                    toEqual(expected) {
                        if (JSON.stringify(actual) === JSON.stringify(expected)) {
                            throw new Error(`Expected ${JSON.stringify(actual)} NOT to equal ${JSON.stringify(expected)}`);
                        }
                    },

                    toContain(item) {
                        if (actual && actual.includes && actual.includes(item)) {
                            throw new Error(`Expected ${JSON.stringify(actual)} NOT to contain ${JSON.stringify(item)}`);
                        }
                    },

                    toBeTruthy() {
                        if (actual) {
                            throw new Error(`Expected ${JSON.stringify(actual)} to be falsy`);
                        }
                    },

                    toBeFalsy() {
                        if (!actual) {
                            throw new Error(`Expected ${JSON.stringify(actual)} to be truthy`);
                        }
                    },

                    toBeDefined() {
                        if (actual !== undefined) {
                            throw new Error(`Expected value to be undefined`);
                        }
                    }
                };

                // Return matchers with .not property
                return {
                    ...matchers,
                    not: notMatchers
                };
            }

            displayResults() {
                const resultsDiv = document.getElementById('test-results');
                const summaryDiv = document.getElementById('test-summary');

                const passed = this.results.filter(r => r.passed).length;
                const failed = this.results.filter(r => !r.passed).length;
                const total = this.results.length;
                const totalDuration = this.results.reduce((sum, r) => sum + r.duration, 0);

                // Summary
                summaryDiv.innerHTML = `
                    <div class="test-summary ${failed === 0 ? 'success-summary' : 'failure-summary'}">
                        <strong>Test Results:</strong>
                        ${passed}/${total} passed
                        ${failed > 0 ? `(${failed} failed)` : '‚úÖ'}
                        - Duration: ${totalDuration.toFixed(2)}ms
                    </div>
                `;

                // Detailed results
                let html = '';
                this.suites.forEach(suite => {
                    html += `<div class="test-section">`;
                    html += `<h3>${suite.name}</h3>`;

                    suite.tests.forEach(test => {
                        html += `
                            <div class="test-result ${test.passed ? 'pass' : 'fail'}">
                                ${test.passed ? '‚úÖ' : '‚ùå'} ${test.name}
                                <span style="color: #666; font-size: 0.9em">(${test.duration.toFixed(2)}ms)</span>
                                ${test.error ? `<div class="error-details">${test.error}</div>` : ''}
                            </div>
                        `;
                    });

                    html += `</div>`;
                });

                resultsDiv.innerHTML = html || '<div class="loading">No tests found</div>';
            }
        };

        // Initialize global test framework
        window.testFramework = new TestFramework();
        window.describe = (name, fn) => window.testFramework.describe(name, fn);
        window.it = (name, fn) => window.testFramework.it(name, fn);
        window.expect = (value) => window.testFramework.expect(value);

        // Test runner functions
        window.runAllTests = async function() {
            console.log('Running all tests...');
            window.testFramework.reset();

            // Import and run test modules
            try {
                // First, load the actual memory game engine using dynamic import
                // This approach has been proven to work in test_audio_import.html
                console.log('Importing memory game engine...');
                try {
                    await import('/language/memory_game_engine.js');
                    console.log('Memory game engine imported successfully');
                    console.log('MemoryGame available:', typeof window.MemoryGame !== 'undefined');
                } catch (error) {
                    console.error('Failed to import memory game engine:', error);
                    // Continue anyway, tests will use mock
                }

                // Then, load the test file
                const testScript = document.createElement('script');
                testScript.src = '/tests/unit/memory-game.test.js';

                // Wait for the script to load
                await new Promise((resolve, reject) => {
                    testScript.onload = async () => {
                        console.log('Test file loaded successfully');

                        // Wait a moment for the script to fully execute
                        setTimeout(() => {
                            // Try to run the exported test function if available
                            if (typeof window.runMemoryGameTests === 'function') {
                                console.log('Running memory game tests from external file...');
                                window.runMemoryGameTests();
                                // Display results after running tests
                                window.testFramework.displayResults();
                                resolve();
                            } else {
                                console.log('runMemoryGameTests not found, running inline example tests...');

                            // Example test - shuffleArray
                            describe('Array Utilities', () => {
                                it('should maintain array length when shuffling', () => {
                                    // Inline implementation for testing
                                    const shuffleArray = (array) => {
                                        const arr = [...array];
                                        for (let i = arr.length - 1; i > 0; i--) {
                                            const j = Math.floor(Math.random() * (i + 1));
                                            [arr[i], arr[j]] = [arr[j], arr[i]];
                                        }
                                        return arr;
                                    };

                                    const input = [1, 2, 3, 4, 5];
                                    const result = shuffleArray(input);

                                    expect(result.length).toBe(5);
                                    expect(result).toContain(1);
                                    expect(result).toContain(5);
                                });

                                it('should not modify original array', () => {
                                    const shuffleArray = (array) => {
                                        const arr = [...array];
                                        for (let i = arr.length - 1; i > 0; i--) {
                                            const j = Math.floor(Math.random() * (i + 1));
                                            [arr[i], arr[j]] = [arr[j], arr[i]];
                                        }
                                        return arr;
                                    };

                                    const input = [1, 2, 3];
                                    const original = [...input];
                                    shuffleArray(input);

                                    expect(input).toEqual(original);
                                });
                            });

                            describe('Game State', () => {
                                it('should initialize with default values', () => {
                                    const gameState = {
                                        score: 0,
                                        pairsFound: 0,
                                        totalPairs: 10,
                                        isLocked: false
                                    };

                                    expect(gameState.score).toBe(0);
                                    expect(gameState.totalPairs).toBe(10);
                                    expect(gameState.isLocked).toBeFalsy();
                                });

                                it('should detect win condition', () => {
                                    const checkWin = (pairsFound, totalPairs) => {
                                        return pairsFound === totalPairs;
                                    };

                                    expect(checkWin(10, 10)).toBeTruthy();
                                    expect(checkWin(9, 10)).toBeFalsy();
                                });
                            });

                            describe('Data Validation', () => {
                                it('should validate topic data structure', () => {
                                    const isValidTopic = (data) => {
                                        return data &&
                                               (Array.isArray(data.entries) || Array.isArray(data.pairs));
                                    };

                                    expect(isValidTopic({ entries: [] })).toBeTruthy();
                                    expect(isValidTopic({ pairs: [] })).toBeTruthy();
                                    expect(isValidTopic({})).toBeFalsy();
                                    expect(isValidTopic(null)).toBeFalsy();
                                });

                                it('should validate card count', () => {
                                    const isValidCardCount = (count) => {
                                        return count > 0 && count % 2 === 0;
                                    };

                                    expect(isValidCardCount(20)).toBeTruthy();
                                    expect(isValidCardCount(10)).toBeTruthy();
                                    expect(isValidCardCount(15)).toBeFalsy();
                                    expect(isValidCardCount(0)).toBeFalsy();
                                });
                            });

                            // Display results
                            window.testFramework.displayResults();
                            resolve();
                        }
                        }, 100); // Give script 100ms to fully execute
                    };

                    testScript.onerror = (error) => {
                        console.error('Error loading test file:', error);
                        console.log('Running inline tests as fallback');
                        // Run inline tests as fallback
                        runInlineTests();
                        resolve();
                    };

                    // Append script to document to start loading
                    document.head.appendChild(testScript);
                });

            } catch (error) {
                console.error('Error running tests:', error);
                document.getElementById('test-results').innerHTML = `
                    <div class="test-result fail">
                        Error loading tests: ${error.message}
                    </div>
                `;
            }
        };

        // Inline tests as a separate function for fallback
        window.runInlineTests = function() {
            console.log('Running inline example tests...');

            // Example test - shuffleArray
            describe('Array Utilities', () => {
                it('should maintain array length when shuffling', () => {
                    const shuffleArray = (array) => {
                        const arr = [...array];
                        for (let i = arr.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [arr[i], arr[j]] = [arr[j], arr[i]];
                        }
                        return arr;
                    };

                    const input = [1, 2, 3, 4, 5];
                    const result = shuffleArray(input);

                    expect(result.length).toBe(5);
                    expect(result).toContain(1);
                    expect(result).toContain(5);
                });

                it('should not modify original array', () => {
                    const shuffleArray = (array) => {
                        const arr = [...array];
                        for (let i = arr.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [arr[i], arr[j]] = [arr[j], arr[i]];
                        }
                        return arr;
                    };

                    const input = [1, 2, 3];
                    const original = [...input];
                    shuffleArray(input);

                    expect(input).toEqual(original);
                });
            });

            describe('Game State', () => {
                it('should initialize with default values', () => {
                    const gameState = {
                        score: 0,
                        pairsFound: 0,
                        totalPairs: 10,
                        isLocked: false
                    };

                    expect(gameState.score).toBe(0);
                    expect(gameState.totalPairs).toBe(10);
                    expect(gameState.isLocked).toBeFalsy();
                });

                it('should detect win condition', () => {
                    const checkWin = (pairsFound, totalPairs) => {
                        return pairsFound === totalPairs;
                    };

                    expect(checkWin(10, 10)).toBeTruthy();
                    expect(checkWin(9, 10)).toBeFalsy();
                });
            });

            describe('Data Validation', () => {
                it('should validate topic data structure', () => {
                    const isValidTopic = (data) => {
                        return data &&
                               (Array.isArray(data.entries) || Array.isArray(data.pairs));
                    };

                    expect(isValidTopic({ entries: [] })).toBeTruthy();
                    expect(isValidTopic({ pairs: [] })).toBeTruthy();
                    expect(isValidTopic({})).toBeFalsy();
                    expect(isValidTopic(null)).toBeFalsy();
                });

                it('should validate card count', () => {
                    const isValidCardCount = (count) => {
                        return count > 0 && count % 2 === 0;
                    };

                    expect(isValidCardCount(20)).toBeTruthy();
                    expect(isValidCardCount(10)).toBeTruthy();
                    expect(isValidCardCount(15)).toBeFalsy();
                    expect(isValidCardCount(0)).toBeFalsy();
                });
            });

            window.testFramework.displayResults();
        };

        window.runUnitTests = function() {
            console.log('Running unit tests...');
            // Placeholder for unit tests only
            window.runAllTests(); // For now, run all
        };

        window.runIntegrationTests = function() {
            console.log('Running integration tests...');
            // Placeholder for integration tests only
            alert('Integration tests not yet implemented');
        };

        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '<div class="loading">Click "Run All Tests" to begin...</div>';
            document.getElementById('test-summary').innerHTML = '';
        };

        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test runner ready!');

            // Connect button click handlers
            document.getElementById('run-all-tests').addEventListener('click', function() {
                console.log('Run All Tests clicked');
                window.runAllTests();
            });

            document.getElementById('run-unit-tests').addEventListener('click', function() {
                console.log('Run Unit Tests clicked');
                window.runUnitTests();
            });

            document.getElementById('run-integration-tests').addEventListener('click', function() {
                console.log('Run Integration Tests clicked');
                window.runIntegrationTests();
            });

            document.getElementById('clear-results').addEventListener('click', function() {
                console.log('Clear Results clicked');
                window.clearResults();
            });

            console.log('Button event listeners attached');
        });
    </script>
</body>
</html>
