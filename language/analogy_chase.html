<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¨×“×£ ×”×× ×œ×•×’×™×•×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            touch-action: manipulation;
            background: linear-gradient(135deg, #6dd5ed 0%, #2193b0 100%);
        }
        #track-container {
             background: rgba(255,255,255,0.1);
             backdrop-filter: blur(10px);
        }
        #track {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            padding: 10px;
        }
        .step {
            width: 4.5%;
            height: 60px;
            background: rgba(255,255,255,0.25);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            color: #1e3a8a;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .step.finish {
            background: #FFD700;
            color: #422006;
            box-shadow: 0 0 20px #FFD700;
            font-size: 2rem;
        }
        .player, .chaser {
            position: absolute;
            bottom: -25px;
            font-size: 2.8rem;
            transition: left 0.5s cubic-bezier(0.45, 0, 0.55, 1);
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.3));
            transform: translateX(-50%);
        }

        .timer-svg {
            transform: rotate(-90deg);
        }
        .timer-circle-progress {
            transition: stroke-dashoffset 0.2s linear;
        }
        .answer-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .answer-btn:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .correct {
            animation: correct-pulse 0.5s ease;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
        }
        .incorrect {
            animation: incorrect-shake 0.5s ease;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
        }
        .main-title {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: #FFD700; /* Gold color */
        }

        @keyframes correct-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes incorrect-shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="w-full max-w-4xl mx-auto">
        <h1 class="main-title text-4xl sm:text-5xl font-bold text-center mb-4">ğŸƒâ€â™‚ï¸ ××¨×“×£ ×”×× ×œ×•×’×™×•×ª ğŸŒ€</h1>

        <!-- ××¡×œ×•×œ ×”××¨×“×£ -->
        <div id="track-container" class="p-4 rounded-2xl shadow-lg mb-4">
            <div id="track">
                <!-- ×”××“×¨×’×•×ª ×™×•×•×¦×¨×• ×“×™× ××™×ª -->
            </div>
        </div>

        <!-- ××–×•×¨ ×”××©×—×§ ×”××¨×›×–×™ -->
        <div class="bg-white p-6 rounded-2xl shadow-xl text-center">

             <!-- Stats Display -->
            <div class="flex justify-around text-center mb-4 pb-4 border-b">
                <div>
                    <div id="player-pos-stat" class="font-bold text-2xl text-sky-600">5</div>
                    <div class="text-sm text-gray-500">××™×§×•× ×”×©×—×§×Ÿ</div>
                </div>
                <div>
                    <div id="chaser-pos-stat" class="font-bold text-2xl text-red-500">0</div>
                    <div class="text-sm text-gray-500">××™×§×•× ×”×¨×•×“×£</div>
                </div>
                <div>
                     <div id="hints-left-stat" class="font-bold text-2xl text-amber-500">5</div>
                    <div class="text-sm text-gray-500">×¨××–×™×</div>
                </div>
            </div>

            <!-- HUD: ×–××Ÿ ×•×¨××–×™× -->
            <div class="flex justify-between items-center mb-4">
                <div class="relative w-20 h-20">
                    <svg id="timer-svg" class="timer-svg w-full h-full" viewBox="0 0 36 36">
                        <path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3.8"></path>
                        <path id="timer-circle" class="timer-circle-progress text-sky-500" stroke-width="3.8" stroke-dasharray="100, 100" stroke-dashoffset="0" fill="none" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                    </svg>
                    <span id="time-display" class="absolute inset-0 flex items-center justify-center text-2xl font-bold"></span>
                </div>

                <button id="hint-btn" class="bg-amber-400 text-white font-bold py-2 px-5 rounded-full shadow-md hover:bg-amber-500 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed">
                    ğŸ’¡ ×¨××– (<span id="hints-left"></span>)
                </button>
            </div>

            <div id="hint-display" class="h-8 text-lg font-semibold text-violet-600 mb-2"></div>

            <!-- ××–×•×¨ ×”×©××œ×” -->
            <div id="question-area" class="mb-6 text-2xl sm:text-3xl">
                <p>
                    <span id="itemA" class="font-bold text-amber-600"></span>
                    ××ª×™×™×—×¡ ×œ-
                    <span id="itemB" class="font-bold text-amber-600"></span>
                </p>
                <p class="mt-2">
                    ×›××• ×©-
                    <span id="itemC" class="font-bold text-sky-600"></span>
                    ××ª×™×™×—×¡/×ª ×œ...
                </p>
            </div>
            <div id="answers-area" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- ×›×¤×ª×•×¨×™ ×”×ª×©×•×‘×•×ª -->
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×¡×™×•× ××©×—×§ -->
    <div id="game-over-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 text-center transform transition-all scale-95 max-w-sm w-full" id="modal-content">
            <div id="modal-icon" class="text-8xl mb-4"></div>
            <h2 id="modal-title" class="text-4xl font-bold mb-4"></h2>
            <p id="modal-text" class="text-lg text-gray-600 mb-6"></p>
            <div class="text-left space-y-2 mb-8 bg-gray-100 p-4 rounded-lg">
                <p class="text-lg">ğŸ“Š <span class="font-bold">××¨×—×§ ××”×¨×•×“×£:</span> <span id="distance-stat"></span> ××“×¨×’×•×ª</p>
                <p class="text-lg">ğŸ’¡ <span class="font-bold">×¨××–×™× ×©× ×•×ª×¨×•:</span> <span id="hints-stat"></span></p>
            </div>
            <button id="play-again-btn" class="bg-sky-500 text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-sky-600 transition-colors w-full">×©×—×§ ×©×•×‘</button>
        </div>
    </div>

    <script>
        // --- ×¤×¨××˜×¨×™× ×œ×›×•×•× ×•×Ÿ ---
        const PLAYER_START_POSITION = 5;
        const TIME_PER_QUESTION = 20;
        const TOTAL_HINTS = 5;
        const FINISH_LINE = 20;
        const HINT_TIME_BONUS = 10;

        // --- ××œ×× ×˜×™× ××”-DOM ---
        const playerEl = document.createElement('div');
        playerEl.id = 'player';
        playerEl.className = 'player';
        playerEl.textContent = 'ğŸƒâ€â™‚ï¸';

        const chaserEl = document.createElement('div');
        chaserEl.id = 'chaser';
        chaserEl.className = 'chaser';
        chaserEl.textContent = 'ğŸŒ€';

        const trackEl = document.getElementById('track');
        const timeDisplay = document.getElementById('time-display');
        const timerCircle = document.getElementById('timer-circle');
        const hintBtn = document.getElementById('hint-btn');
        const hintsLeftEl = document.getElementById('hints-left');
        const hintDisplay = document.getElementById('hint-display');
        const answersArea = document.getElementById('answers-area');
        const itemAEl = document.getElementById('itemA');
        const itemBEl = document.getElementById('itemB');
        const itemCEl = document.getElementById('itemC');
        const playerPosStat = document.getElementById('player-pos-stat');
        const chaserPosStat = document.getElementById('chaser-pos-stat');
        const hintsLeftStat = document.getElementById('hints-left-stat');

        // Modal elements
        const gameOverModal = document.getElementById('game-over-modal');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const distanceStat = document.getElementById('distance-stat');
        const hintsStat = document.getElementById('hints-stat');
        const playAgainBtn = document.getElementById('play-again-btn');

        // --- ××©×ª× ×™ ××¦×‘ ×”××©×—×§ ---
        let playerPosition, chaserPosition, hintsLeft, timeLeft, timerInterval;
        let currentCorrectAnswer = '';
        let analogyPool = [];
        let currentAnalogyIndex = 0;

        // --- × ×ª×•× ×™ ×”××©×—×§ (××•×˜××¢) ---
        const analogiesData = [
          {"relationCategory":"×¨××©×•×Ÿ ×•××—×¨×•×Ÿ (×‘×¡×“×¨×”)","pairs":[{"itemA":"×™×•×¨×”","itemB":"××œ×§×•×©","distractorsA":["××‘×™×‘","×§×™×¥","×¡×ª×™×•","×’×©×"],"distractorsB":["×’×©×","×—×•×¨×£","×¢× ×Ÿ","×‘×¨×“"]},{"itemA":"×‘×›×•×¨","itemB":"×‘×Ÿ ×–×§×•× ×™×","distractorsA":["×ª×™× ×•×§","×™×œ×“","× ×›×“","××—×™×™×Ÿ"],"distractorsB":["××—","× ×›×“","×”×•×¨×”","×ª××•×"]},{"itemA":"×'","itemB":"×ª'","distractorsA":["×‘'","×’'","××™×œ×”","××•×ª"],"distractorsB":["×©'","×¡×•×£","×-×‘","××•×ª"]}]},
          {"relationCategory":"× ×™×™×“ ××•×œ × ×™×™×—","pairs":[{"itemA":"×¡×•×œ×","itemB":"××“×¨×’×•×ª","distractorsA":["××¢×§×”","×—×‘×œ","×›×™×¡×","××“×¨×›×”"],"distractorsB":["××¢×œ×™×ª","×“×¨×’× ×•×¢","×¨××¤×”","×—×‘×œ"]},{"itemA":"××•×”×œ","itemB":"×‘×™×ª","distractorsA":["×§×¨×•×•××Ÿ","×¡×•×›×”","×‘×§×ª×”","×¦×¨×™×£"],"distractorsB":["×¦×¨×™×£","×§×¨×•×•××Ÿ","×’×’","××—× ×”"]},{"itemA":"××—×©×‘ × ×™×™×“","itemB":"××—×©×‘ ×©×•×œ×—× ×™","distractorsA":["×˜×œ×¤×•×Ÿ","×˜××‘×œ×˜","××¡×š","×¢×›×‘×¨"],"distractorsB":["×˜×œ×•×•×™×–×™×”","×©×•×œ×—×Ÿ","××§×œ×“×ª","×—×©××œ"]}]},
          {"relationCategory":"×”×¡×¤×§ × ××•×š ××•×œ ×’×‘×•×”","pairs":[{"itemA":"××¢×“×¨","itemB":"×“×—×¤×•×¨","distractorsA":["××ª ×—×¤×™×¨×”","××’×¨×¤×”","×˜×•×¨×™×”","×›×£"],"distractorsB":["×˜×¨×§×˜×•×¨","××¨×™×¦×”","××’×¨×¤×”","××©××™×ª"]},{"itemA":"×—×›×”","itemB":"×¨×©×ª ×“×™×™×’×™×","distractorsA":["×¡×™×¨×”","×§×¨×¡","×¡×¤×™× ×ª ×“×™×’","×¤×™×ª×™×•×Ÿ"],"distractorsB":["×¡×™×¨×”","×¤×™×ª×™×•×Ÿ","×“×’","×§×¨×¡"]},{"itemA":"××˜××˜×","itemB":"×©×•××‘ ××‘×§","distractorsA":["×™×¢×”","×¡××¨×˜×•×˜","××’×‘","××‘×§"],"distractorsB":["×—×©××œ","×¨×¢×©","×©×˜×™×—","×œ×›×œ×•×š"]}]},
          {"relationCategory":"×ª×›×•× ×” ×•×™×—×™×“×ª ××™×“×”","pairs":[{"itemA":"××•×¨×š","itemB":"×¡× ×˜×™××˜×¨","distractorsA":["×¨×•×—×‘","×¢×•××§","×’×•×‘×”","××¨×—×§"],"distractorsB":["××˜×¨","××™× ×¥'","×¡×¨×’×œ","×§×™×œ×•××˜×¨"]},{"itemA":"××©×§×œ","itemB":"×’×¨×","distractorsA":["× ×¤×—","×˜××¤×¨×˜×•×¨×”","××”×™×¨×•×ª","×–××Ÿ"],"distractorsB":["×××–× ×™×™×","×›×‘×“","×œ×™×˜×¨","××˜×¨"]},{"itemA":"×–××Ÿ","itemB":"×©× ×™×™×”","distractorsA":["×©×¢×•×Ÿ","××”×™×¨×•×ª","××•×¨×š","×“×§×”"],"distractorsB":["×“×§×”","×©×¢×”","×©×¢×•×Ÿ","××”×¨"]},{"itemA":"×˜××¤×¨×˜×•×¨×”","itemB":"××¢×œ×”","distractorsA":["×—×•×","×§×•×¨","××“×—×•×","××–×’ ××•×•×™×¨"],"distractorsB":["××—×•×–","×§×™×œ×•××˜×¨","×’×¨×","×—×•×"]}]},
          {"relationCategory":"×‘×¢×œ ××§×¦×•×¢ ×•×”×ª×•×¦×¨","pairs":[{"itemA":"×˜×‘×—","itemB":"××–×•×Ÿ","distractorsA":["××•×¤×”","×§×•× ×“×™×˜×•×¨","××œ×¦×¨","×—×§×œ××™"],"distractorsB":["××¨×•×—×”","××¡×¢×“×”","×¡×™×¨","××˜×‘×—"]},{"itemA":"×¦×•×¨×£","itemB":"×ª×›×©×™×˜","distractorsA":["×ª×›×©×™×˜×Ÿ","×™×”×œ×•××Ÿ","× ×¤×—","×—× ×•×ª"],"distractorsB":["×–×”×‘","×›×¡×£","×˜×‘×¢×ª","××•×¤×”"]},{"itemA":"××•×¤×”","itemB":"×××¤×”","distractorsA":["×˜×‘×—","×§×•× ×“×™×˜×•×¨","×§××—","××•×›×¨"],"distractorsB":["×œ×—×","×¢×•×’×”","×§××—","×ª× ×•×¨"]}]},
          {"relationCategory":"×”××¦××” ×•×××¦×™×","pairs":[{"itemA":"× ×•×¨×”","itemB":"×ª×•××¡ ××“×™×¡×•×Ÿ","distractorsA":["×—×©××œ","×¤×˜×™×¤×•×Ÿ","×˜×œ×’×¨×£","×–×¨× ×™×©×¨"],"distractorsB":["× ×™×§×•×œ×” ×˜×¡×œ×”","×‘× ×’'××™×Ÿ ×¤×¨× ×§×œ×™×Ÿ","×¤××¨××“×™×™"]},{"itemA":"××˜×•×¡","itemB":"×”××—×™× ×¨×™×™×˜","distractorsA":["×ª×¢×•×¤×”","× ×•×¨×”","×˜×œ×¤×•×Ÿ","×¨×“×™×•"],"distractorsB":["×. ×’×¨×”× ×‘×œ","××™×™× ×©×˜×™×™×Ÿ","×˜×™×™×¡","×›× ×¤×™×™×"]},{"itemA":"×˜×œ×¤×•×Ÿ","itemB":"×. ×’×¨×”× ×‘×œ","distractorsA":["×˜×œ×•×•×™×–×™×”","×¨×“×™×•","×œ×“×‘×¨","×—×•×˜"],"distractorsB":["××“×™×¡×•×Ÿ","××¨×§×•× ×™","××™×™× ×©×˜×™×™×Ÿ","×œ×“×‘×¨"]}]},
          {"relationCategory":"×”×¤×›×™×","pairs":[{"itemA":"××ª×•×Ÿ","itemB":"×§×™×¦×•× ×™","distractorsA":["×¨×’×™×œ","×××•×¦×¢","×¨×“×™×§×œ×™","×©×¤×•×™"],"distractorsB":["×¨×’×•×¢","×—×¨×™×£","×××•×¦×¢","×—×–×§"]},{"itemA":"×¨×•×‘","itemB":"××™×¢×•×˜","distractorsA":["×›×•×œ×","××¢×˜","× ×“×™×¨","×‘×•×“×“"],"distractorsB":["×”×¨×‘×”","××¢×˜","×—×œ×§","×›×•×œ×"]},{"itemA":"×’×‘×•×”","itemB":"× ××•×š","distractorsA":["××¨×•×š","×¨×—×‘","×©××Ÿ","×œ××¢×œ×”"],"distractorsB":["×§×¦×¨","×¦×¨","×¨×–×”","×œ××˜×”"]},{"itemA":"×©××Ÿ","itemB":"×¨×–×”","distractorsA":["×’×“×•×œ","×¨×—×‘","×¢×‘×”","×‘×¨×™×"],"distractorsB":["×“×§","×¦×¨","×§×˜×Ÿ","×—×œ×©"]}]}
        ];

        // Import from common library
        let shuffleArray = null;
        let audioModule = null;
        let timerModule = null;
        let gameTimer = null;
        let modulesLoaded = false;

        // Load shuffleArray module
        import('../common/utils/array.js').then(module => {
            shuffleArray = module.shuffleArrayCopy;
            console.log('Array module loaded');
            // Start game if audio is also ready
            if (audioModule) {
                startGameIfReady();
            }
        }).catch(error => {
            console.error('Failed to load array module:', error);
            // Provide fallback for shuffleArray
            shuffleArray = function(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };
            startGameIfReady();
        });

        // Load audio module (like in division_signs.html)
        import('../common/audio/sounds.js').then(module => {
            audioModule = module;
            console.log('[analogy_chase] Audio module loaded successfully');
            console.log('[analogy_chase] Available audio functions:', Object.keys(module));
            // Start game if array is also ready
            if (shuffleArray) {
                startGameIfReady();
            }
        }).catch(error => {
            console.error('[analogy_chase] Failed to load audio module:', error);
            // Game can still run without audio
            if (shuffleArray) {
                startGameIfReady();
            }
        });

        // Load timer module
        import('../common/timer/countdown_timer.js').then(module => {
            timerModule = module;
            console.log('[analogy_chase] Timer module loaded successfully');
        }).catch(error => {
            console.error('[analogy_chase] Failed to load timer module:', error);
        });

        function startGameIfReady() {
            if (modulesLoaded) return;
            if (!shuffleArray) return;

            modulesLoaded = true;
            createTrack();
            resetGame();
        }

        function populateAndShuffleAnalogyPool() {
            if (!shuffleArray) {
                console.error('shuffleArray not loaded yet');
                return;
            }
            analogyPool = [];

            // Create all possible question combinations from the data
            analogiesData.forEach(category => {
                if (category.pairs && category.pairs.length >= 2) {
                    // Create questions by using each pair combination
                    for (let i = 0; i < category.pairs.length; i++) {
                        for (let j = 0; j < category.pairs.length; j++) {
                            if (i !== j) {
                                analogyPool.push({
                                    categoryName: category.relationCategory,
                                    pair1: category.pairs[i],
                                    pair2: category.pairs[j]
                                });
                            }
                        }
                    }
                }
            });

            // Shuffle the pool to randomize question order
            analogyPool = shuffleArray(analogyPool);
            currentAnalogyIndex = 0;
            console.log(`Generated ${analogyPool.length} questions`);
        }

        function createTrack() {
            trackEl.innerHTML = '';
            for (let i = 0; i <= FINISH_LINE; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                if (i === FINISH_LINE) {
                    step.classList.add('finish');
                    step.innerHTML = 'ğŸ†';
                } else {
                    step.textContent = i;
                }
                trackEl.appendChild(step);
            }
            trackEl.appendChild(playerEl);
            trackEl.appendChild(chaserEl);
        }

        async function resetGame() {
            playerPosition = PLAYER_START_POSITION;
            chaserPosition = 0;
            hintsLeft = TOTAL_HINTS;

            gameOverModal.classList.add('hidden');

            // Initialize audio on user interaction (like in division_signs.html)
            console.log('[analogy_chase] resetGame: Trying to init audio. audioModule=', audioModule);
            if (audioModule) {
                console.log('[analogy_chase] Calling audioModule.initAudio()');
                audioModule.initAudio();
            }

            populateAndShuffleAnalogyPool();

            updatePositions();
            updateStatsDisplay();
            await generateQuestion();
        }

        function updatePositions() {
            // For RTL layout, we need to position from left instead of right
            const playerPercent = (playerPosition / FINISH_LINE) * 100;
            const chaserPercent = (chaserPosition / FINISH_LINE) * 100;

            // In RTL, higher positions should appear on the left (start of reading direction)
            // So we invert the percentage: 100% - calculated%
            const playerLeft = 100 - playerPercent;
            const chaserLeft = 100 - chaserPercent;

            // Use left positioning for RTL layout
            playerEl.style.left = `${Math.max(playerLeft, 5)}%`;
            chaserEl.style.left = `${Math.max(chaserLeft, 5)}%`;

            // Remove any right positioning that might interfere
            playerEl.style.right = '';
            chaserEl.style.right = '';
        }

        function updateStatsDisplay() {
            playerPosStat.textContent = playerPosition;
            chaserPosStat.textContent = chaserPosition;
            hintsLeftStat.textContent = hintsLeft;
            hintsLeftEl.textContent = hintsLeft;
        }

        function startTimer() {
            // Stop any existing timer
            if (gameTimer) {
                gameTimer.stop();
            }

            // Create new timer for this question
            if (timerModule) {
                gameTimer = timerModule.createCircularTimer({
                    duration: TIME_PER_QUESTION,
                    svgCircle: timerCircle,
                    textElement: timeDisplay,
                    circumference: 100, // The SVG uses 100 as circumference
                    onTick: (timeRemaining) => {
                        timeLeft = timeRemaining;
                    },
                    onComplete: () => {
                        handleAnswer(false);
                    },
                    warningTime: 5
                });

                gameTimer.start();
            } else {
                // Fallback if timer module not loaded
                timeLeft = TIME_PER_QUESTION;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timeDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        handleAnswer(false);
                    }
                }, 1000);
            }
        }

        function stopTimer() {
            if (gameTimer) {
                gameTimer.stop();
            } else if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        async function generateQuestion() {
            if (!shuffleArray || !analogyPool || analogyPool.length === 0) {
                console.error('Game not properly initialized');
                return;
            }

            // Initialize audio if needed
            console.log('[analogy_chase] generateQuestion: Trying to init audio. audioModule=', audioModule);
            if (audioModule) {
                console.log('[analogy_chase] Calling audioModule.initAudio() from generateQuestion');
                audioModule.initAudio();
            }

            hintDisplay.textContent = '';
            hintBtn.disabled = (hintsLeft === 0);

            if (currentAnalogyIndex >= analogyPool.length) {
                // Reshuffle the pool to continue playing
                currentAnalogyIndex = 0;
                analogyPool = shuffleArray(analogyPool);
                console.log('Reshuffled question pool for continued play');
            }

            const analogy = analogyPool[currentAnalogyIndex];
            currentAnalogyIndex++;

            let examplePair = analogy.pair1;
            let questionPair = analogy.pair2;
            let distractors;

            const shouldReverse = Math.random() < 0.5;

            if (shouldReverse) {
                itemAEl.textContent = examplePair.itemB;
                itemBEl.textContent = examplePair.itemA;
                itemCEl.textContent = questionPair.itemB;
                currentCorrectAnswer = questionPair.itemA;
                distractors = questionPair.distractorsA;
            } else {
                itemAEl.textContent = examplePair.itemA;
                itemBEl.textContent = examplePair.itemB;
                itemCEl.textContent = questionPair.itemA;
                currentCorrectAnswer = questionPair.itemB;
                distractors = questionPair.distractorsB;
            }

            hintBtn.onclick = () => useHint(analogy.categoryName);

            const options = shuffleArray([currentCorrectAnswer, ...shuffleArray(distractors || []).slice(0, 3)]);

            answersArea.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'answer-btn p-4 rounded-lg shadow-md text-xl font-semibold';
                button.textContent = option;
                button.addEventListener('click', (e) => handleAnswer(e.target.textContent === currentCorrectAnswer, e.target));
                answersArea.appendChild(button);
            });

            startTimer();
        }

        async function handleAnswer(isCorrect, clickedButton = null) {
            stopTimer();
            answersArea.querySelectorAll('button').forEach(btn => btn.disabled = true);
            hintBtn.onclick = null;

            if (isCorrect) {
                playerPosition++;     // Player moves forward 1 position
                chaserPosition++;     // Chaser also moves forward 1 position
                if (clickedButton) {
                    clickedButton.classList.add('correct');
                }
                // Play success sound
                console.log('Trying to play success sound, audioModule:', audioModule);
                if (audioModule) {
                    console.log('audioModule exists, calling playSuccessSound');
                    audioModule.playSuccessSound();
                } else {
                    console.log('audioModule is null/undefined');
                }
            } else {
                chaserPosition++;     // Chaser moves forward 1 position
                // Player doesn't move on wrong answer
                if (clickedButton) {
                    clickedButton.classList.add('incorrect');
                }
                answersArea.querySelectorAll('button').forEach(btn => {
                    if (btn.textContent === currentCorrectAnswer) {
                        btn.classList.add('correct');
                    }
                });
                // Play error sound
                console.log('Trying to play error sound, audioModule:', audioModule);
                if (audioModule) {
                    console.log('audioModule exists, calling playErrorSound');
                    audioModule.playErrorSound();
                } else {
                    console.log('audioModule is null/undefined');
                }
            }

            setTimeout(() => {
                updatePositions();
                updateStatsDisplay();
                setTimeout(async () => {
                    await checkGameEnd();
                }, 600);
            }, 500);
        }

        async function checkGameEnd() {
            if (playerPosition >= FINISH_LINE) {
                showGameOver(true);
            } else if (chaserPosition >= playerPosition) {
                showGameOver(false);
            } else {
                await generateQuestion();
            }
        }

        function useHint(categoryName) {
            if (hintsLeft > 0) {
                hintsLeft--;
                // Add time using the common timer module
                if (gameTimer) {
                    gameTimer.addTime(HINT_TIME_BONUS);
                } else {
                    // Fallback
                    timeLeft = Math.min(TIME_PER_QUESTION, timeLeft + HINT_TIME_BONUS);
                }
                updateStatsDisplay();
                hintDisplay.textContent = `×¨××–: ${categoryName}`;
                hintBtn.disabled = true;
                hintBtn.onclick = null;
            }
        }

        function showGameOver(didWin, customMessage = null) {
            if (didWin) {
                modalIcon.textContent = 'ğŸ‰';
                modalTitle.textContent = '× ×™×¦×—×ª!';
                modalTitle.className = 'text-4xl font-bold mb-4 text-green-500';
                modalText.textContent = customMessage || '×‘×¨×—×ª ××”×¨×•×“×£ ×•×”×’×¢×ª ××œ ×”×’×‘×™×¢!';
                // Play victory sound
                console.log('Trying to play victory sound, audioModule:', audioModule);
                if (audioModule) {
                    console.log('audioModule exists, calling playVictorySound');
                    audioModule.playVictorySound();
                } else {
                    console.log('audioModule is null/undefined');
                }
            } else {
                modalIcon.textContent = 'ğŸŒ€';
                modalTitle.textContent = '×”×¤×¡×“×ª...';
                modalTitle.className = 'text-4xl font-bold mb-4 text-red-500';
                modalText.textContent = '×”×¨×•×“×£ ×”×©×™×’ ××•×ª×š. × ×¡×” ×©×•×‘!';
                // Play game over sound (lose) - only in chase game
                console.log('Trying to play game over sound, audioModule:', audioModule);
                if (audioModule) {
                    console.log('audioModule exists, calling playGameOverSound');
                    audioModule.playGameOverSound();
                } else {
                    console.log('audioModule is null/undefined');
                }
            }
            distanceStat.textContent = Math.max(0, playerPosition - chaserPosition);
            hintsStat.textContent = hintsLeft;
            gameOverModal.classList.remove('hidden');
        }

        // Event Listeners
        playAgainBtn.addEventListener('click', resetGame);
        window.addEventListener('resize', updatePositions);

        // Initialize audio on first user interaction (like in division_signs.html)
        document.addEventListener('click', function() {
            console.log('[analogy_chase] First click detected. audioModule=', audioModule);
            if (audioModule) {
                console.log('[analogy_chase] Calling audioModule.initAudio() from first click');
                audioModule.initAudio();
            }
        }, { once: true });

        document.addEventListener('touchstart', function() {
            console.log('[analogy_chase] First touch detected. audioModule=', audioModule);
            if (audioModule) {
                console.log('[analogy_chase] Calling audioModule.initAudio() from first touch');
                audioModule.initAudio();
            }
        }, { once: true });
    </script>
</body>
</html>

